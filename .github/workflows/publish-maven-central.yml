name: Publish to Maven Central

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Semantic Version Bump Type'
        required: true
        type: choice
        options:
          - auto
          - major
          - minor
          - patch
        default: auto
      major_description:
        description: 'MAJOR (X.0.0): Breaking changes - incompatible API changes'
        required: false
        type: string
        default: '---'
      minor_description:
        description: 'MINOR (x.Y.0): New features - backwards compatible additions'
        required: false
        type: string
        default: '---'
      patch_description:
        description: 'PATCH (x.y.Z): Bug fixes - backwards compatible fixes'
        required: false
        type: string
        default: '---'
      custom_version:
        description: 'Custom version (e.g., 2.0.0) - Overrides bump_type if specified'
        required: false
        type: string

jobs:
  version:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    outputs:
      version: ${{ steps.determine-version.outputs.version }}
      tag: ${{ steps.determine-version.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: determine-version
        run: |
          echo "=========================================="
          echo "  Semantic Versioning: MAJOR.MINOR.PATCH"
          echo "=========================================="
          echo ""
          echo "  MAJOR (X.0.0): Breaking changes - REQUIRES HUMAN APPROVAL"
          echo "  MINOR (x.Y.0): New features - backwards compatible"
          echo "  PATCH (x.y.Z): Bug fixes - most common release type"
          echo ""
          echo "=========================================="

          # If custom version is provided, use it directly
          if [ -n "${{ inputs.custom_version }}" ]; then
            VERSION="${{ inputs.custom_version }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
            echo "Using custom version: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=v$VERSION" >> $GITHUB_OUTPUT
            echo "version_changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get current version from build.gradle.kts
          CURRENT_VERSION=$(grep -oP 'version\s*=\s*"\K[^"]+' build.gradle.kts)
          echo "Current version: $CURRENT_VERSION"

          # Parse current version into MAJOR.MINOR.PATCH
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          echo "Parsed: MAJOR=$MAJOR, MINOR=$MINOR, PATCH=$PATCH"

          # Get the last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Last tag: $LAST_TAG"

          # Get commits since last tag for logging
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")
          echo ""
          echo "Commits since $LAST_TAG:"
          echo "$COMMITS"
          echo ""

          # Determine bump type
          BUMP_TYPE="${{ inputs.bump_type }}"

          # MAJOR changes MUST be explicitly selected by a human
          # Auto mode only detects MINOR (features) or PATCH (fixes)
          if [ "$BUMP_TYPE" == "auto" ]; then
            # Check for breaking changes - warn but default to PATCH (human must select MAJOR)
            if echo "$COMMITS" | grep -qiE "^(feat|fix|refactor|perf)(\(.+\))?!:|BREAKING CHANGE:"; then
              echo "WARNING: Breaking change detected in commits!"
              echo "MAJOR version bumps require explicit human approval."
              echo "Defaulting to PATCH. Select 'major' manually if this is a breaking change."
              BUMP_TYPE="patch"
            # Check for new features -> MINOR (less frequent)
            elif echo "$COMMITS" | grep -qiE "^feat(\(.+\))?:"; then
              BUMP_TYPE="minor"
              echo "Auto-detected: MINOR bump (new feature found)"
            # Default to PATCH for everything else (most common)
            else
              BUMP_TYPE="patch"
              echo "Auto-detected: PATCH bump (default for fixes and improvements)"
            fi
          fi

          echo ""
          echo "Selected bump type: $BUMP_TYPE"

          # Apply version bump based on semantic versioning rules
          case "$BUMP_TYPE" in
            major)
              # MAJOR: X.0.0 - Increment MAJOR, reset MINOR and PATCH
              # Only happens when explicitly selected by human
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              echo "Applying MAJOR bump: Breaking changes - incompatible API changes"
              echo "This version indicates breaking changes to consumers!"
              ;;
            minor)
              # MINOR: x.Y.0 - Increment MINOR, reset PATCH
              # New features that are backwards compatible
              MINOR=$((MINOR + 1))
              PATCH=0
              echo "Applying MINOR bump: New features - backwards compatible additions"
              ;;
            patch)
              # PATCH: x.y.Z - Increment only PATCH
              # Bug fixes and small improvements (most releases)
              PATCH=$((PATCH + 1))
              echo "Applying PATCH bump: Bug fixes and improvements"
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo ""
          echo "Version change: $CURRENT_VERSION -> $NEW_VERSION"

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

          if [ "$NEW_VERSION" != "$CURRENT_VERSION" ]; then
            echo "version_changed=true" >> $GITHUB_OUTPUT
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Update version in build.gradle.kts
        if: steps.determine-version.outputs.version_changed == 'true'
        run: |
          NEW_VERSION="${{ steps.determine-version.outputs.version }}"
          sed -i "s/version = \".*\"/version = \"$NEW_VERSION\"/" build.gradle.kts
          echo "Updated build.gradle.kts to version $NEW_VERSION"
          grep 'version\s*=' build.gradle.kts

      - name: Commit and tag new version
        if: steps.determine-version.outputs.version_changed == 'true'
        run: |
          NEW_VERSION="${{ steps.determine-version.outputs.version }}"
          TAG="${{ steps.determine-version.outputs.tag }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add build.gradle.kts
          git commit -m "chore(release): bump version to $NEW_VERSION [skip ci]"
          git tag "$TAG"

          git push origin main
          git push origin "$TAG"

          echo "Created and pushed tag $TAG"

  build:
    needs: version
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.version.outputs.tag }}
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          gpg --list-secret-keys

      - name: Build and sign artifacts
        run: ./gradlew clean build publishToMavenLocal --no-daemon -x test
        env:
          ORG_GRADLE_PROJECT_signing.gnupg.keyName: ${{ secrets.GPG_KEY_ID }}

      - name: Create deployment bundle
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          echo "Building bundle for version: $VERSION"

          cd /tmp

          # Create directories
          for module in aggo-core aggo-migrations aggo-spring-boot-starter; do
            mkdir -p "aggorm-bundle/com/aggitech/orm/$module/$VERSION"
          done

          for module in aggo-core aggo-migrations aggo-spring-boot-starter; do
            src=~/.m2/repository/com/aggitech/orm/$module/$VERSION
            dest=/tmp/aggorm-bundle/com/aggitech/orm/$module/$VERSION

            echo "Copying $module artifacts from $src to $dest"

            # Copy artifacts
            cp "$src/$module-$VERSION.jar" "$dest/"
            cp "$src/$module-$VERSION.pom" "$dest/"
            cp "$src/$module-$VERSION-sources.jar" "$dest/"
            cp "$src/$module-$VERSION-javadoc.jar" "$dest/"
            cp "$src/$module-$VERSION.jar.asc" "$dest/"
            cp "$src/$module-$VERSION.pom.asc" "$dest/"
            cp "$src/$module-$VERSION-sources.jar.asc" "$dest/"
            cp "$src/$module-$VERSION-javadoc.jar.asc" "$dest/"

            # Generate checksums
            cd "$dest"
            for file in "$module-$VERSION.jar" "$module-$VERSION.pom" "$module-$VERSION-sources.jar" "$module-$VERSION-javadoc.jar"; do
              md5sum "$file" | awk '{print $1}' > "$file.md5"
              sha1sum "$file" | awk '{print $1}' > "$file.sha1"
            done
            cd /tmp
          done

          cd /tmp/aggorm-bundle
          zip -r "/tmp/aggorm-$VERSION.zip" com/
          ls -lh "/tmp/aggorm-$VERSION.zip"

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: aggorm-bundle
          path: /tmp/aggorm-*.zip
          retention-days: 5

  publish:
    needs: [version, build]
    runs-on: ubuntu-latest
    environment: maven-central
    permissions:
      contents: write

    steps:
      - name: Download bundle artifact
        uses: actions/download-artifact@v4
        with:
          name: aggorm-bundle
          path: /tmp

      - name: Upload to Maven Central
        run: |
          VERSION="${{ needs.version.outputs.version }}"

          echo "Uploading version $VERSION to Maven Central..."

          RESPONSE=$(curl -X POST \
            -u "${{ secrets.OSSRH_USERNAME }}:${{ secrets.OSSRH_PASSWORD }}" \
            -F "bundle=@/tmp/aggorm-$VERSION.zip" \
            -F "publishingType=AUTOMATIC" \
            https://central.sonatype.com/api/v1/publisher/upload)

          echo "Deployment ID: $RESPONSE"
          echo "DEPLOYMENT_ID=$RESPONSE" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          # Check if upload was successful
          if [ -z "$RESPONSE" ]; then
            echo "Error: Failed to upload to Maven Central"
            exit 1
          fi

      - name: Wait for validation
        run: |
          echo "Deployment submitted successfully!"
          echo "Deployment ID: ${{ env.DEPLOYMENT_ID }}"
          echo "Check status at: https://central.sonatype.com/publishing/deployments"
          echo "Artifacts will be available at: https://central.sonatype.com/artifact/com.aggitech.orm/aggo-core"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.version.outputs.tag }}
          name: Release ${{ needs.version.outputs.tag }}
          body: |
            ## AggORM ${{ needs.version.outputs.tag }}

            Published to Maven Central with deployment ID: `${{ env.DEPLOYMENT_ID }}`

            ### Maven Coordinates

            ```kotlin
            dependencies {
                implementation("com.aggitech.orm:aggo-core:${{ env.VERSION }}")
                implementation("com.aggitech.orm:aggo-migrations:${{ env.VERSION }}")
                implementation("com.aggitech.orm:aggo-spring-boot-starter:${{ env.VERSION }}")
            }
            ```

            The artifacts will be available on Maven Central within a few hours.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ needs.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ needs.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment ID:** ${{ env.DEPLOYMENT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Maven Coordinates" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`kotlin" >> $GITHUB_STEP_SUMMARY
          echo "implementation(\"com.aggitech.orm:aggo-core:${{ needs.version.outputs.version }}\")" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
